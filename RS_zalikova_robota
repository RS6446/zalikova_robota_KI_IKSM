import streamlit as st
import pandas as pd
import random
import csv
import os
from dataclasses import dataclass
from typing import List, Literal
from abc import ABC, abstractmethod

#–ö–ª–∞—Å–∏, —Å—Ç—É–¥–µ–Ω—Ç–∏ —Ç–∞ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏
@dataclass
class Person:
    surname: str
    name: str
    patronymic: str

    @property
    def full_name(self) -> str: #Type Hints —è–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ –¢–ó
        return f"{self.surname} {self.name} {self.patronymic}"


@dataclass
class Student(Person):
    birth_year: int
    gender: Literal['M', 'F']
    average_score: float

class SchoolClass:
    def __init__(self, grade: int, letter: str):
        self.grade = grade
        self.letter = letter
        self.students: List[Student] = []

    def add_student(self, student: Student):
        self.students.append(student)

    def promote(self):
        self.grade += 1

    @property
    def name(self):
        return f"{self.grade}-{self.letter}"


# –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏
@dataclass
class Employee(Person, ABC):
    base_salary: float

    @abstractmethod
    def calculate_salary(self) -> float: pass


@dataclass
class Director(Employee):
    pedagogical_experience: int
    management_experience: int

    def calculate_salary(self) -> float:
        return self.base_salary * (self.pedagogical_experience / 50) + (self.management_experience * 500)


@dataclass
class Teacher(Employee):
    pedagogical_experience: int

    def calculate_salary(self) -> float:
        return self.base_salary * (self.pedagogical_experience / 30)


@dataclass
class Security(Employee):
    general_experience: int

    def calculate_salary(self) -> float:
        return self.base_salary + (self.general_experience * 250)

# 2 - –§—É–Ω–∫—Ü—ñ—ó
def generate_csv_if_not_exists():
    if os.path.exists("students.csv"):
        return

    first_names_m = ["–û–ª–µ–∫—Å–∞–Ω–¥—Ä", "–î–º–∏—Ç—Ä–æ", "–ú–∞–∫—Å–∏–º", "–ê—Ä—Ç–µ–º", "–Ü–≤–∞–Ω"]
    first_names_f = ["–ê–Ω–Ω–∞", "–ú–∞—Ä—ñ—è", "–°–æ—Ñ—ñ—è", "–Ñ–≤–∞", "–í—ñ–∫—Ç–æ—Ä—ñ—è"]
    surnames = ["–®–µ–≤—á–µ–Ω–∫–æ", "–ö–æ–≤–∞–ª–µ–Ω–∫–æ", "–ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ", "–ü–µ—Ç—Ä–µ–Ω–∫–æ", "–ö—Ä–∞–≤—á–µ–Ω–∫–æ"]

    data_rows = []
    for grade in range(1, 12):
        for letter in ['–ê', '–ë']:
            num_students = random.randint(15, 25)
            for _ in range(num_students):
                gender = random.choice(['M', 'F'])
                name = random.choice(first_names_m) if gender == 'M' else random.choice(first_names_f)
                surname = random.choice(surnames)
                birth_year = 2024 - grade - 6  # –ü—Ä–∏–±–ª–∏–∑–Ω–∏–π —Ä—ñ–∫
                avg_score = round(random.uniform(5.0, 12.0), 1)

                data_rows.append({
                    "grade": grade, "letter": letter, "surname": surname, "name": name,
                    "patronymic": "–Ü–≤–∞–Ω–æ–≤–∏—á", "birth_year": birth_year, "gender": gender, "average_score": avg_score
                })

    with open("students.csv", "w", encoding="utf-8", newline="") as f:
        writer = csv.DictWriter(f, fieldnames=data_rows[0].keys())
        writer.writeheader()
        writer.writerows(data_rows)


def load_school_data() -> List[SchoolClass]:
    classes_list = []
    class_map = {}

    with open("students.csv", "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            g_id = f"{row['grade']}-{row['letter']}"
            if g_id not in class_map:
                new_class = SchoolClass(int(row['grade']), row['letter'])
                classes_list.append(new_class)
                class_map[g_id] = new_class

            student = Student(
                surname=row['surname'], name=row['name'], patronymic=row['patronymic'],
                birth_year=int(row['birth_year']), gender=row['gender'], average_score=float(row['average_score'])
            )
            class_map[g_id].add_student(student)
    return classes_list

# 3) STREAMLIT –Ü–ù–¢–ï–†–§–ï–ô–°
st.set_page_config(page_title="–°–∏—Å—Ç–µ–º–∞ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —à–∫–æ–ª–æ—é", layout="wide")
st.title("–°–∏—Å—Ç–µ–º–∞ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —à–∫–æ–ª–æ—é '–û–ø—Ç—ñ–º–∞'!")

generate_csv_if_not_exists() # - –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É

# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Session State, —â–æ–± –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å—Ç–∞–Ω –∫–ª–∞—Å—ñ–≤ –º—ñ–∂ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è–º–∏ –∫–Ω–æ–ø–æ–∫
if 'school_classes' not in st.session_state:
    st.session_state['school_classes'] = load_school_data()
    st.session_state['year_offset'] = 0

# –°—Ç–≤–æ—Ä—é—î–º–æ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –¥–≤–æ—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤
tab1, tab2 = st.tabs(["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ –£—á–Ω—ñ", "–ó–∞—Ä–ø–ª–∞—Ç–∏"])

#Scenario 1: —É—á–Ω—ñ —Ç–∞ —ó—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
with tab1:
    classes = st.session_state['school_classes']
    # –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö –¥–ª—è DataFrame (–¥–ª—è –∑—Ä—É—á–Ω–æ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏/–º–µ—Ç—Ä–∏–∫–∏)
    all_students_data = []
    for c in classes:
        for s in c.students:
            all_students_data.append({
                "Grade": c.grade,
                "Letter": c.letter,
                "FullClass": c.name,
                "Gender": s.gender,
                "Score": s.average_score,
                "Year": s.birth_year
            })
    df = pd.DataFrame(all_students_data)

    if df.empty:
        st.warning("–£ —à–∫–æ–ª—ñ –Ω–µ–º–∞—î —É—á–Ω—ñ–≤ (–º–æ–∂–ª–∏–≤–æ, –≤—Å—ñ –≤–∏–ø—É—Å—Ç–∏–ª–∏—Å—è).")
    else:
        st.subheader("–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        col1, col2, col3, col4 = st.columns(4)
        total_students = len(df)
        boys = len(df[df['Gender'] == 'M'])
        girls = len(df[df['Gender'] == 'F'])
        col1.metric("–í—Å—å–æ–≥–æ —É—á–Ω—ñ–≤", total_students)
        col2.metric("–•–ª–æ–ø—Ü—ñ / –î—ñ–≤—á–∞—Ç–∞", f"{boys} / {girls}",
        help=f"{boys / total_students:.1%} / {girls / total_students:.1%}")
        col3.metric("–°–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª –ø–æ —à–∫–æ–ª—ñ", f"{df['Score'].mean():.2f}")
        col4.metric("–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª–∞—Å—ñ–≤", len(classes))

        # –Ω–∞—à max/min
        class_counts = df['FullClass'].value_counts()
        st.info(f"–ù–∞–π–±—ñ–ª—å—à–∏–π –∫–ª–∞—Å: **{class_counts.idxmax()} ({class_counts.max()} —É—á–Ω—ñ–≤) | "
                f"–ù–∞–π–º–µ–Ω—à–∏–π –∫–ª–∞—Å: **{class_counts.idxmin()} ({class_counts.min()} —É—á–Ω—ñ–≤)")

        st.divider()

        #–ì—Ä–∞—Ñ—ñ–∫–∏
        st.subheader("–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è")
        c1, c2 = st.columns(2)

        with c1:
            st.write("–†–æ–∑–ø–æ–¥—ñ–ª —É—á–Ω—ñ–≤ –ø–æ –ø–∞—Ä–∞–ª–µ–ª—è—Ö") #–†–æ–±–ª—é –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è –ø–æ –∫–ª–∞—Å–∞–º
            grade_counts = df['Grade'].value_counts().sort_index()
            st.bar_chart(grade_counts)

            st.write("–°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É—á–Ω—ñ–≤ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—è—Ö (–ê, –ë...)")
            vert_counts = df.groupby('Letter').size() / df['Letter'].nunique()  #—Å–ø—Ä–æ—â–µ–Ω–∞ —Ñ–æ—Ä–º–∞
            # –¢–æ—á–Ω—ñ—à–µ –∫–∞–∂—É—á–∏: —Å–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É—á–Ω—ñ–≤ —É –∫–ª–∞—Å–∞—Ö –∑ –ª—ñ—Ç–µ—Ä–æ—é –ê, –ë, ..., n
            avg_vert = df.groupby(['Letter', 'Grade']).size().groupby('Letter').mean()
            st.bar_chart(avg_vert)

        with c2:
            st.write("–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É—á–Ω—ñ–≤ –∑–∞ —Ä–æ–∫–æ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è")
            year_counts = df['Year'].value_counts().sort_index()
            st.line_chart(year_counts)
            st.write("–ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å —Å–µ—Ä–µ–¥–Ω—å–æ—ó –æ—Ü—ñ–Ω–∫–∏ –≤—ñ–¥ –∫–ª–∞—Å—É")
            st.scatter_chart(df, x='Grade', y='Score', color='Gender', size=20) # Scatter chart —É Streamlit

    st.divider()

    #–ú—ñ–≥—Ä—É—î–º–æ –Ω–∞ —Ä—ñ–∫ –≤–ø–µ—Ä–µ–¥
    st.subheader("–ö–µ—Ä—É–≤–∞–Ω–Ω—è —á–∞—Å–æ–º")
    if st.button("üöÄ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —à–∫–æ–ª—É –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–∫"):
        new_classes = []
        graduated_count = 0

        for c in st.session_state['school_classes']:
            if c.grade < 11:
                c.promote()
                new_classes.append(c)
            else:
                graduated_count += 1

        st.session_state['school_classes'] = new_classes
        st.session_state['year_offset'] += 1
        st.success(f"–†—ñ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –í–∏–ø—É—â–µ–Ω–æ –∫–ª–∞—Å—ñ–≤: {graduated_count}. –£—Å—ñ —ñ–Ω—à—ñ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ñ.")
        st.rerun()

    if st.session_state['year_offset'] > 0:
        st.warning(
            f"–®–∫–æ–ª–∞ –∑–º—ñ—â–µ–Ω–∞ –Ω–∞ {st.session_state['year_offset']} —Ä–æ–∫—ñ–≤ –≤–ø–µ—Ä–µ–¥. 1-—Ö –∫–ª–∞—Å—ñ–≤ –∑–∞—Ä–∞–∑ –Ω–µ–º–∞—î (–∑–∞ —É–º–æ–≤–æ—é –∑–∞–¥–∞—á—ñ).")
#–ó–∞—Ä–ø–ª–∞—Ç–∏
with tab2:
    st.header("–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è —Ç–∞ –ó–∞—Ä–ø–ª–∞—Ç–∏")
    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤ (—Ö–∞—Ä–¥–∫–æ–¥!)
    staff = [
        Director("–ì–∞–ª—É—â–µ–Ω–∫–æ", "–Ü–≤–∞–Ω", "–Ü–≤–∞–Ω–æ–≤–∏—á", base_salary=15000, pedagogical_experience=20, management_experience=5),
        Teacher("–ü–µ—Ç—Ä–µ–Ω–∫–æ", "–ú–∞—Ä—ñ—è", "–ü–µ—Ç—Ä—ñ–≤–Ω–∞", base_salary=12000, pedagogical_experience=10),
        Teacher("–ö—Ä—ñ–ø–∫–∞", "–û–ª–µ–≥", "–í–∞—Å–∏–ª—å–æ–≤–∏—á", base_salary=12000, pedagogical_experience=5),
        Security("–ë—É–≥–∞–π", "–°–µ—Ä–≥—ñ–π", "–û–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á", base_salary=11000, general_experience=8)
    ]
    #–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
    salary_data = []
    for p in staff:
        salary_data.append({
            "–ü–Ü–ë": p.full_name,
            "–ü–æ—Å–∞–¥–∞": type(p).__name__,
            "–ë–∞–∑–æ–≤–∞ —Å—Ç–∞–≤–∫–∞": p.base_salary,
            "–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ": round(p.calculate_salary(), 2)
        })
    df_salary = pd.DataFrame(salary_data)
    st.dataframe(df_salary, use_container_width=True) # - —Ç–∞–±–ª–∏—Ü—è
    csv_data = df_salary.to_csv(index=False).encode('utf-8') # - csv

    st.download_button(
        label="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç (CSV)",
        data=csv_data,
        file_name="salaries.csv",
        mime="text/csv",
    )
